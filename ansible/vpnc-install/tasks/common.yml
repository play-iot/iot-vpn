---
- name: Transfer binary
  copy:
    src: binary/qweio-vpnc-amd64
    dest: "{{ vpn_dir }}/"
    owner: root
    group: root
    mode: u+x,g+x
  when: ansible_architecture == "x86_64"

- name: Create symlink
  file:
    src: "{{ vpn_dir }}/qweio-vpnc-amd64"
    dest: "{{ bin_path }}/qweio-vpnc"
    owner: root
    group: root
    state: link

- name: Cleanup existing VPN installation
  command: qweio-vpnc uninstall -dd {{ vpn_dir }}/vpnclient -f
  when: clean_up|bool

- name: Install VPN client
  command: qweio-vpnc install --auto-startup --dnsmasq -dd {{ vpn_dir }}/vpnclient -dn {{ vpn_service }} -ds {{ service_dir }} -vv
  register: vpn_install
  ignore_errors: True

- name: Configure VPN client with password authentication
  command: qweio-vpnc add -sh {{ vpn_server }} -sp {{ vpn_port }} -su {{ vpn_hub }} -ca {{ vpn_account }} -ct password -cu {{ vpn_user }} -cp {{ vpn_password }} -dd {{ vpn_dir }}/vpnclient -v
  when: vpn_auth_type == "password"
  register: vpn_configure
  ignore_errors: True
  when: vpn_install.rc == 0

- name: Configure VPN client with client certificate authentication
  command: qweio-vpnc add -sh {{ vpn_server }} -sp {{ vpn_port }} -su {{ vpn_hub }} -ca {{ vpn_account }} -ct cert -cu {{ vpn_user }} -cpk {{ vpn_prv_key }} -cck {{ vpn_cert }} -dd {{ vpn_dir }}/vpnclient -v
  when: vpn_auth_type == "cert"
  register: vpn_configure
  ignore_errors: True
  when: vpn_install.rc == 0
